name: "build Megatron wheel"

on:
  workflow_dispatch:
    inputs:
      base_image:
        description: 'base container image'
        required: true
        default: 'quay.io/pypa/manylinux_2_28_x86_64'
        type: string
      python3_minor_ver:
        description: 'python3 minor version'
        required: true
        type: choice
        options:
          - '10'
          - '11'
          - '12'
          - '13'
        default: '12'

jobs:
  build-wheel:
    name: build Megatron wheel
    runs-on: self-hosted
    # environment: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get short SHA
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.slime-wheel
          build-args: |
            BASE_IMAGE=${{ github.event.inputs.base_image }}
            PY3_VER=${{ github.event.inputs.python3_minor_ver }}
          target: wheels
          # type=tar is used as a workaround since type=local sometimes hangs for hours. necessitates "extract wheels" step.
          outputs: type=tar,dest=./out.tar
          # can't push image if we're outputting it to a .tar. consider uncommenting if you'd prefer the alternative.
          # push: true
          # tags: ghcr.io/my-cool-org/slime-megatron-wheel:${{ env.SHORT_SHA }}
      - name: Extract wheels
        run: |
          mkdir -p ./out
          tar -xf ./out.tar -C ./out
      - name: List built wheels
        run: |
          echo "## Built Wheels ðŸŽ¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Wheel | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
          for wheel in ./out/wheels/*.whl; do
            name=$(basename "$wheel")
            size=$(du -h "$wheel" | cut -f1)
            echo "| \`$name\` | $size |" >> $GITHUB_STEP_SUMMARY
          done
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels
          path: ./out/wheels/*.whl

